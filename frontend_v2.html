<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanify v2-alpha Control Panel</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .control-panel {
            display: grid;
            grid-template-areas: 
                "header header header"
                "sidebar map bins-status"
                "status map bins-status";
            grid-template-columns: 350px 1fr 350px;
            grid-template-rows: 60px 1fr 120px;
            height: 100vh;
        }

        .header {
            grid-area: header;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar {
            grid-area: sidebar;
            background: rgba(0, 0, 0, 0.4);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bins-status-sidebar {
            grid-area: bins-status;
            background: rgba(0, 0, 0, 0.4);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 20px;
        }

        .bins-status-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .bin-status-item {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bin-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .bin-id {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .bin-fill-percentage {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .bin-fill-bar {
            position: relative;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .bin-fill-level {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            transition: width 0.3s ease;
            border-radius: 13px 0 0 13px;
        }

        .bin-overflow-area {
            position: absolute;
            right: 0;
            top: 0;
            width: 20%;
            height: 100%;
            background: rgba(128, 128, 128, 0.3);
            border-radius: 0 13px 13px 0;
        }

        .bin-fill-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            z-index: 10;
        }

        .bin-details {
            margin-top: 8px;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .bin-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .hourly-rate-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }

        .rate-low { background: #4CAF50; }
        .rate-medium { background: #FFC107; }
        .rate-high { background: #FF9800; }
        .rate-critical { background: #F44336; }

        .map-container {
            grid-area: map;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .config-upload {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-input-wrapper {
            position: relative;
            cursor: pointer;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: block;
            width: 100%;
            padding: 10px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #4CAF50;
            color: white;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-secondary {
            background: #757575;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .metric-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        .simulation-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .simulation-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .simulation-info div {
            margin-bottom: 4px;
        }

        .simulation-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .status-bar {
            grid-area: status;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .connection-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-status {
            font-size: 0.85rem;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .config-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }

        .config-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .config-status.loading {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            color: #ff9800;
        }

        /* Route and truck movement styles */
        .route-line {
            stroke-width: 4;
            stroke-opacity: 0.8;
            fill: none;
        }

        .route-active {
            stroke: #2196F3;
            stroke-dasharray: 8,4;
            animation: route-dash 2s linear infinite;
        }

        .route-planned {
            stroke: #FF9800;
            stroke-dasharray: 12,6;
        }

        .route-completed {
            stroke: #4CAF50;
        }

        @keyframes route-dash {
            from { stroke-dashoffset: 0; }
            to { stroke-dashoffset: -12; }
        }

        .truck-moving {
            animation: truck-pulse 1.5s ease-in-out infinite;
        }

        @keyframes truck-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <!-- Header -->
        <div class="header">
            <div class="logo">Cleanify v2-alpha</div>
            <div class="system-status">
                <div class="status-dot" id="systemStatusDot"></div>
                <span id="systemStatusText">System Ready</span>
            </div>
        </div>

        <!-- Left Sidebar -->
        <div class="sidebar">
            <!-- Configuration Section -->
            <div class="sidebar-section">
                <div class="section-title">Configuration</div>
                <div class="config-upload">
                    <div class="file-input-wrapper">
                        <input type="file" id="configFile" class="file-input" accept=".json,.csv">
                        <label for="configFile" class="file-input-button">
                            Upload Config (JSON/CSV)
                        </label>
                    </div>
                    <button class="btn btn-secondary" onclick="loadSampleConfig()">Load Sample</button>
                    <button class="btn" onclick="exportState()" id="exportBtn" disabled>Export State</button>
                </div>
                <div id="configStatus" class="config-status loading">Ready to load configuration</div>
            </div>

            <!-- Metrics Section -->
            <div class="sidebar-section">
                <div class="section-title">System Metrics</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="binCount">0</div>
                        <div class="metric-label">Bins</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="truckCount">0</div>
                        <div class="metric-label">Trucks</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="urgentBins">0</div>
                        <div class="metric-label">Urgent Bins</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="activeRoutes">0</div>
                        <div class="metric-label">Active Routes</div>
                    </div>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="sidebar-section">
                <div class="section-title">Simulation</div>
                <div class="simulation-controls">
                    <button class="btn" onclick="startSimulation()" id="startBtn" disabled>
                        Start
                    </button>
                    <button class="btn btn-danger" onclick="pauseSimulation()" id="pauseBtn" disabled>
                        Pause
                    </button>
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="font-size: 0.85rem; opacity: 0.8;">Simulation Speed</label>
                    <input type="range" id="speedSlider" min="0.5" max="25" step="0.5" value="1" 
                           style="width: 100%; margin-top: 5px;" disabled>
                    <div style="text-align: center; font-size: 0.8rem; margin-top: 5px;">
                        <span id="speedValue">1.0x</span>
                    </div>
                </div>
                
                <div class="simulation-info" id="simulationInfo">
                    <div><strong>Status:</strong> <span id="simStatus">Stopped</span></div>
                    <div><strong>Time:</strong> <span id="simTime" class="simulation-time">--:--</span></div>
                    <div><strong>Speed:</strong> <span id="simSpeed">1.0x</span></div>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="triggerRoutes()" id="routeBtn" disabled>
                        Trigger Routes
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Bins Status -->
        <div class="bins-status-sidebar">
            <div class="bins-status-title">Bins Status</div>
            <div id="binsStatusContainer">
                <div style="text-align: center; padding: 20px; opacity: 0.6;">
                    No bins loaded
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="connection-status">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div id="connectionIndicator" class="loading-spinner"></div>
                    <span id="connectionStatus">Connecting to backend...</span>
                </div>
                <div>
                    <span id="lastUpdate">Last update: Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let markers = {
            bins: new Map(),
            trucks: new Map(),
            depot: null
        };
        let routes = new Map();
        let systemState = null;
        let currentConfig = null;
        let updateInterval = null;
        let isUpdating = false;
        let simulationState = {
            running: false,
            currentTime: null,
            speed: 1.0
        };

        // API Configuration
        const API_BASE = 'http://localhost:8000/api';

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            startUpdateLoop();
            showConfigStatus('Ready to load configuration', 'loading');
        });

        function initializeMap() {
            map = L.map('map').setView([33.6844, 73.0479], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        function setupEventListeners() {
            document.getElementById('configFile').addEventListener('change', handleFileUpload);
            
            document.getElementById('speedSlider').addEventListener('input', function(e) {
                const speed = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = speed + 'x';
                document.getElementById('simSpeed').textContent = speed + 'x';
                setSimulationSpeed(speed);
            });
        }

        // Time formatting
        function formatSimulationTime(timeString) {
            if (!timeString || timeString === 'undefined' || timeString === 'null') {
                return '--:--';
            }
            
            try {
                const date = new Date(timeString);
                if (isNaN(date.getTime())) {
                    return '--:--';
                }
                
                return date.toLocaleTimeString('en-US', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return '--:--';
            }
        }

        function getCurrentHour(timeString) {
            try {
                const date = new Date(timeString);
                return date.getHours();
            } catch (e) {
                return 8; // Default to 8 AM
            }
        }

        // Enhanced bins status with hourly rates
        function updateBinsStatusSidebar() {
            const container = document.getElementById('binsStatusContainer');
            
            if (!systemState || !systemState.bins || systemState.bins.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; opacity: 0.6;">
                        No bins loaded
                    </div>
                `;
                return;
            }

            const currentHour = getCurrentHour(systemState.current_time);
            let html = '';
            
            systemState.bins.forEach(bin => {
                const fillLevel = bin.fill_level || 0;
                const fillPercentage = Math.min(fillLevel, 100);
                const baseFillRate = bin.fill_rate_lph || 3.0;
                
                // Calculate hourly fill rate based on current simulation time
                let hourlyMultiplier = 1.0;
                let rateCategory = 'rate-low';
                
                if (6 <= currentHour <= 10) {
                    hourlyMultiplier = 1.8;
                    rateCategory = 'rate-high';
                } else if (17 <= currentHour <= 21) {
                    hourlyMultiplier = 1.5;
                    rateCategory = 'rate-medium';
                } else if (22 <= currentHour || currentHour <= 5) {
                    hourlyMultiplier = 0.3;
                    rateCategory = 'rate-low';
                }
                
                const currentHourlyRate = (baseFillRate * hourlyMultiplier).toFixed(1);
                const capacityLiters = bin.capacity_l || 100;
                const currentFillLiters = (capacityLiters * fillLevel / 100).toFixed(1);
                
                // Time to full calculation
                const remainingCapacity = capacityLiters - parseFloat(currentFillLiters);
                const timeToFull = remainingCapacity > 0 ? (remainingCapacity / parseFloat(currentHourlyRate)).toFixed(1) : 0;

                html += `
                    <div class="bin-status-item">
                        <div class="bin-status-header">
                            <div class="bin-id">${bin.id}</div>
                            <div class="bin-fill-percentage">${fillLevel.toFixed(1)}%</div>
                        </div>
                        <div class="bin-fill-bar">
                            <div class="bin-fill-level" style="width: ${fillPercentage}%"></div>
                            <div class="bin-overflow-area"></div>
                            <div class="bin-fill-text">${fillLevel.toFixed(0)}%</div>
                        </div>
                        <div class="bin-details">
                            <div class="bin-detail-row">
                                <span>Capacity:</span>
                                <span>${capacityLiters}L</span>
                            </div>
                            <div class="bin-detail-row">
                                <span>Current Fill:</span>
                                <span>${currentFillLiters}L</span>
                            </div>
                            <div class="bin-detail-row">
                                <span>Hour ${currentHour} Rate:</span>
                                <span>${currentHourlyRate}L/h <div class="hourly-rate-indicator ${rateCategory}"></div></span>
                            </div>
                            <div class="bin-detail-row">
                                <span>Time to Full:</span>
                                <span>${timeToFull}h</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Enhanced route visualization with movement
        function updateRoutes() {
            if (!systemState || !systemState.active_routes) return;

            // Clear existing routes
            routes.forEach(route => map.removeLayer(route));
            routes.clear();

            // Add active routes with movement animation
            systemState.active_routes.forEach(route => {
                if (route.waypoints && route.waypoints.length > 1) {
                    const latlngs = route.waypoints.map(wp => [wp.lat, wp.lon]);
                    
                    const polyline = L.polyline(latlngs, {
                        className: `route-line route-${route.status}`,
                        color: getRouteColor(route.status),
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);

                    polyline.bindPopup(`
                        <b>Route:</b> ${route.id}<br>
                        <b>Truck:</b> ${route.truck_id}<br>
                        <b>Status:</b> ${route.status}<br>
                        <b>Bins:</b> ${route.bin_ids ? route.bin_ids.length : 0}<br>
                        <b>Duration:</b> ${route.estimated_duration || 'N/A'}min
                    `);

                    routes.set(route.id, polyline);
                }
            });
        }

        function getRouteColor(status) {
            switch(status) {
                case 'active': return '#2196F3';
                case 'completed': return '#4CAF50';
                case 'planned': return '#FF9800';
                default: return '#757575';
            }
        }

        // Enhanced truck movement visualization
        function updateMap() {
            if (!systemState) return;

            // Clear existing markers
            clearMarkers();

            // Add depot marker
            if (currentConfig && currentConfig.depot) {
                markers.depot = L.circleMarker([currentConfig.depot.latitude, currentConfig.depot.longitude], {
                    radius: 12,
                    fillColor: '#FF5722',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`<b>Depot:</b> ${currentConfig.depot.name}`);
            }

            // Add bin markers
            if (systemState.bins && Array.isArray(systemState.bins)) {
                systemState.bins.forEach((bin) => {
                    if (bin.lat && bin.lon && !isNaN(bin.lat) && !isNaN(bin.lon)) {
                        const fillLevel = bin.fill_level || 0;
                        const color = getFillLevelColor(fillLevel);
                        
                        const marker = L.circleMarker([bin.lat, bin.lon], {
                            radius: Math.max(6, 6 + (fillLevel / 100) * 4),
                            fillColor: color,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);

                        const popupContent = `
                            <b>Bin:</b> ${bin.id}<br>
                            <b>Fill Level:</b> ${fillLevel.toFixed(1)}%<br>
                            <b>Capacity:</b> ${bin.capacity_l}L<br>
                            <b>Current Rate:</b> ${bin.current_hourly_rate || bin.fill_rate_lph}L/h<br>
                            <b>Status:</b> ${fillLevel >= 95 ? 'Critical' : fillLevel >= 85 ? 'Urgent' : 'Normal'}
                        `;
                        marker.bindPopup(popupContent);
                        
                        markers.bins.set(bin.id, marker);
                    }
                });
            }

            // Add truck markers with movement animation
            if (systemState.trucks && Array.isArray(systemState.trucks)) {
                systemState.trucks.forEach((truck) => {
                    if (truck.lat && truck.lon && !isNaN(truck.lat) && !isNaN(truck.lon)) {
                        const isMoving = truck.status === 'EN_ROUTE' || truck.status === 'COLLECTING';
                        
                        const marker = L.circleMarker([truck.lat, truck.lon], {
                            radius: 10,
                            fillColor: getTruckColor(truck.status),
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8,
                            className: isMoving ? 'truck-moving' : ''
                        }).addTo(map);

                        const popupContent = `
                            <b>Truck:</b> ${truck.name || truck.id}<br>
                            <b>Status:</b> ${truck.status}<br>
                            <b>Load:</b> ${truck.current_load_l || 0}/${truck.capacity_l}L<br>
                            <b>Utilization:</b> ${(((truck.current_load_l || 0) / (truck.capacity_l || 1)) * 100).toFixed(1)}%<br>
                            <b>Route:</b> ${truck.current_route_id || 'None'}
                        `;
                        marker.bindPopup(popupContent);
                        
                        markers.trucks.set(truck.id, marker);
                    }
                });
            }
        }

        function getTruckColor(status) {
            switch(status) {
                case 'IDLE': return '#4CAF50';
                case 'EN_ROUTE': return '#2196F3';
                case 'COLLECTING': return '#FF9800';
                case 'RETURNING': return '#9C27B0';
                default: return '#757575';
            }
        }

        function clearMarkers() {
            markers.bins.forEach(marker => map.removeLayer(marker));
            markers.trucks.forEach(marker => map.removeLayer(marker));
            if (markers.depot) map.removeLayer(markers.depot);
            
            markers.bins.clear();
            markers.trucks.clear();
            markers.depot = null;
        }

        function getFillLevelColor(fillLevel) {
            if (fillLevel >= 95) return '#F44336';
            if (fillLevel >= 85) return '#FF9800';
            if (fillLevel >= 50) return '#FFC107';
            return '#4CAF50';
        }
        // Frontend - add to updateRoutes()
        function drawCorridorArea(route) {
            if (!route.waypoints) return;
            
            // Create 250m buffer around route
            const corridorRadius = 250; // meters
            const corridorPolygon = [];
            
            for (let i = 0; i < route.waypoints.length - 1; i++) {
                // Create buffer points around each segment
                // Simplified version - draw circles around waypoints
                const circle = L.circle([route.waypoints[i].lat, route.waypoints[i].lon], {
                    radius: corridorRadius,
                    fillColor: 'yellow',
                    fillOpacity: 0.2,
                    color: 'orange',
                    weight: 1
                }).addTo(map);
                
                corridorAreas.set(`corridor_${route.id}_${i}`, circle);
            }
        }
        // Enhanced system state update with faster refresh
        async function updateSystemState() {
            if (isUpdating) return;
            isUpdating = true;

            try {
                const response = await fetch(`${API_BASE}/system-state`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                systemState = await response.json();
                console.log('=== DEBUG ===');
                console.log('Urgent bins:', systemState.bins?.filter(b => b.fill_level >= 85).map(b => `${b.id}:${b.fill_level.toFixed(1)}%`));
                console.log('Idle trucks:', systemState.trucks?.filter(t => t.status === 'IDLE').map(t => `${t.id}:${t.status}`));
                console.log('Active routes:', systemState.active_routes?.length || 0);
                console.log('Simulation running:', systemState.simulation_running);
                console.log('All truck statuses:', systemState.trucks?.map(t => `${t.id}:${t.status}`));
                updateMetrics();
                updateSimulationInfo();
                updateMap();
                updateRoutes();
                updateBinsStatusSidebar();
                
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionIndicator').style.display = 'none';
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                document.getElementById('connectionStatus').textContent = 'Connection error';
                document.getElementById('connectionIndicator').style.display = 'block';
            } finally {
                isUpdating = false;
            }
        }

        function updateMetrics() {
            if (!systemState) return;

            const binCount = systemState.bins ? systemState.bins.length : 0;
            const truckCount = systemState.trucks ? systemState.trucks.length : 0;
            const urgentBins = systemState.bins ? systemState.bins.filter(bin => bin.fill_level >= 85).length : 0;
            const activeRoutes = systemState.active_routes ? systemState.active_routes.length : 0;

            document.getElementById('binCount').textContent = binCount;
            document.getElementById('truckCount').textContent = truckCount;
            document.getElementById('urgentBins').textContent = urgentBins;
            document.getElementById('activeRoutes').textContent = activeRoutes;
        }

        function updateSimulationInfo() {
            if (!systemState) return;

            const isRunning = systemState.simulation_running || false;
            const currentTime = systemState.current_time;
            const speed = systemState.simulation_speed || 1.0;

            document.getElementById('speedSlider').value = speed;
            document.getElementById('speedValue').textContent = speed + 'x';
            document.getElementById('simSpeed').textContent = speed + 'x';

            const timeDisplay = formatSimulationTime(currentTime);
            document.getElementById('simTime').textContent = timeDisplay;
            document.getElementById('simStatus').textContent = isRunning ? 'Running' : 'Stopped';

            document.getElementById('routeBtn').disabled = !systemState.bins || systemState.bins.length === 0;
        }

        // Simulation Controls
        async function startSimulation() {
            try {
                showConfigStatus('Starting simulation...', 'loading');
                const result = await apiCall('/simulation/start', 'POST');
                
                if (result && result.status === 'simulation_started') {
                    showConfigStatus('Simulation started', 'success');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('pauseBtn').disabled = false;
                    document.getElementById('simStatus').textContent = 'Running';
                } else {
                    throw new Error('Invalid simulation start response');
                }
            } catch (error) {
                showConfigError('Failed to start simulation: ' + error.message);
            }
        }

        async function pauseSimulation() {
            try {
                showConfigStatus('Pausing simulation...', 'loading');
                const result = await apiCall('/simulation/pause', 'POST');
                
                if (result && result.status === 'simulation_paused') {
                    showConfigStatus('Simulation paused', 'loading');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                    document.getElementById('simStatus').textContent = 'Stopped';
                } else {
                    throw new Error('Invalid simulation pause response');
                }
            } catch (error) {
                showConfigError('Failed to pause simulation: ' + error.message);
            }
        }

        async function setSimulationSpeed(speed) {
            try {
                await apiCall('/simulation/speed', 'POST', { speed });
            } catch (error) {
                console.error('Set speed error:', error);
            }
        }

        async function triggerRoutes() {
            try {
                showConfigStatus('Triggering route planning...', 'loading');
                const result = await apiCall('/routes/trigger', 'POST');
                
                if (result && result.status === 'success') {
                    showConfigStatus(`Routes created: ${result.routes_created}`, 'success');
                } else {
                    showConfigStatus(`${result.message}`, 'loading');
                }
            } catch (error) {
                showConfigError('Failed to trigger routes: ' + error.message);
            }
        }

        // API Helper
        async function apiCall(endpoint, method = 'GET', data = null) {
            const url = `${API_BASE}${endpoint}`;
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: data ? JSON.stringify(data) : null
            };

            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        }

        // Configuration Management
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showConfigStatus('Processing file...', 'loading');
                const fileContent = await file.text();
                let config;

                if (file.name.endsWith('.json')) {
                    config = JSON.parse(fileContent);
                } else if (file.name.endsWith('.csv')) {
                    config = await parseCSVConfig(fileContent);
                } else {
                    throw new Error('Unsupported file type. Use JSON or CSV.');
                }

                await processAndUploadConfig(config);

            } catch (error) {
                showConfigError('File processing error: ' + error.message);
            }
        }

        async function loadSampleConfig() {
            try {
                showConfigStatus('Loading sample configuration...', 'loading');
                
                const sampleConfig = {
                    depot: {
                        name: "Central Depot",
                        latitude: 33.6844,
                        longitude: 73.0479
                    },
                    trucks: [
                        {
                            id: "TRUCK_001",
                            name: "Alpha Truck",
                            capacity: 5000
                        },
                        {
                            id: "TRUCK_002", 
                            name: "Beta Truck",
                            capacity: 7000
                        }
                    ],
                    bins: [
                        {
                            id: "BIN_001",
                            latitude: 33.6854,
                            longitude: 73.0489,
                            capacity_l: 120,
                            fill_level: 75.5,
                            fill_rate_lph: 4.2
                        },
                        {
                            id: "BIN_002",
                            latitude: 33.6834,
                            longitude: 73.0469,
                            capacity_l: 100,
                            fill_level: 45.2,
                            fill_rate_lph: 2.8
                        },
                        {
                            id: "BIN_003",
                            latitude: 33.6874,
                            longitude: 73.0499,
                            capacity_l: 150,
                            fill_level: 88.7,
                            fill_rate_lph: 6.1
                        },
                        {
                            id: "BIN_004",
                            latitude: 33.6804,
                            longitude: 73.0459,
                            capacity_l: 120,
                            fill_level: 92.3,
                            fill_rate_lph: 5.5
                        },
                        {
                            id: "BIN_005",
                            latitude: 33.6884,
                            longitude: 73.0509,
                            capacity_l: 100,
                            fill_level: 67.8,
                            fill_rate_lph: 3.9
                        }
                    ]
                };

                await processAndUploadConfig(sampleConfig);

            } catch (error) {
                showConfigError('Failed to load sample config: ' + error.message);
            }
        }

        async function processAndUploadConfig(config) {
            currentConfig = validateAndFixConfig(config);
            await uploadConfigToBackend(currentConfig);
        }

        function validateAndFixConfig(config) {
            if (!config.depot || !config.depot.latitude || !config.depot.longitude) {
                throw new Error('Invalid depot: must have latitude and longitude');
            }

            if (!Array.isArray(config.trucks) || config.trucks.length === 0) {
                throw new Error('Invalid trucks: must be non-empty array');
            }

            if (!Array.isArray(config.bins) || config.bins.length === 0) {
                throw new Error('Invalid bins: must be non-empty array');
            }

            config.bins.forEach((bin, i) => {
                if (!bin.id || bin.latitude === undefined || bin.longitude === undefined) {
                    throw new Error(`Invalid bin ${i}: missing required fields`);
                }
                
                if (!bin.capacity_l) bin.capacity_l = 100;
                if (bin.fill_level === undefined) bin.fill_level = 50.0;
                if (bin.fill_rate_lph === undefined) bin.fill_rate_lph = 3.0;
            });

            return config;
        }

        async function uploadConfigToBackend(config) {
            try {
                showConfigStatus('Uploading configuration...', 'loading');
                
                const result = await apiCall('/load-config', 'POST', config);
                
                if (result && result.status === 'success') {
                    showConfigStatus(`Config uploaded: ${result.trucks} trucks, ${result.bins} bins`, 'success');
                    
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('speedSlider').disabled = false;
                    
                    if (config.depot) {
                        map.setView([config.depot.latitude, config.depot.longitude], 14);
                    }
                    
                    setTimeout(async () => {
                        await updateSystemState();
                    }, 1000);
                    
                } else {
                    throw new Error('Backend rejected configuration');
                }
            } catch (error) {
                showConfigError('Config upload failed: ' + error.message);
            }
        }

        async function exportState() {
            if (!systemState) {
                showConfigError('No system state to export');
                return;
            }

            try {
                const exportData = {
                    config: currentConfig,
                    state: systemState,
                    timestamp: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cleanify-state-${new Date().toISOString().slice(0, 19)}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                showConfigStatus('State exported successfully', 'success');
            } catch (error) {
                showConfigError('Export failed: ' + error.message);
            }
        }

        function showConfigStatus(message, type) {
            const statusElement = document.getElementById('configStatus');
            statusElement.textContent = message;
            statusElement.className = `config-status ${type}`;
        }

        function showConfigError(message) {
            showConfigStatus(`Error: ${message}`, 'error');
        }

        async function parseCSVConfig(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const bins = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length >= 4) {
                    const bin = {
                        id: values[0] || `BIN_${i}`,
                        latitude: parseFloat(values[1]),
                        longitude: parseFloat(values[2]),
                        capacity_l: parseInt(values[3]) || 100,
                        fill_level: parseFloat(values[4]) || 50,
                        fill_rate_lph: parseFloat(values[5]) || 3.0
                    };
                    bins.push(bin);
                }
            }

            return {
                depot: {
                    name: "CSV Depot",
                    latitude: 33.6844,
                    longitude: 73.0479
                },
                trucks: [
                    { id: "TRUCK_001", name: "Default Truck", capacity: 5000 }
                ],
                bins: bins
            };
        }

        // Enhanced update loop with faster refresh for smooth simulation
        function startUpdateLoop() {
            updateInterval = setInterval(async () => {
                await updateSystemState();
            }, 1500); // Faster updates for smoother simulation

            setTimeout(async () => {
                await updateSystemState();
            }, 1000);
        }

        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>