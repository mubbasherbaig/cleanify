<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanify v2-alpha Control Panel - Fixed</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .control-panel {
            display: grid;
            grid-template-areas: 
                "header header"
                "sidebar map"
                "status map";
            grid-template-columns: 350px 1fr;
            grid-template-rows: 60px 1fr 120px;
            height: 100vh;
        }

        .header {
            grid-area: header;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sidebar {
            grid-area: sidebar;
            background: rgba(0, 0, 0, 0.4);
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .map-container {
            grid-area: map;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .status-bar {
            grid-area: status;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .config-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .btn-danger {
            background: #F44336;
        }

        .btn-danger:hover {
            background: #D32F2F;
        }

        .config-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            text-align: center;
        }

        .config-status.loading {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }

        .config-status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .config-status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .metric-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .simulation-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .simulation-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 15px;
            background: #FF9800;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            background: #F57C00;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-section {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .debug-section h4 {
            color: #FF9800;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .debug-info {
            font-size: 0.75rem;
            opacity: 0.8;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <!-- Header -->
        <div class="header">
            <div class="logo">Cleanify v2-alpha</div>
            <div class="system-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="systemStatusText">System Online</span>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Configuration Section -->
            <div class="sidebar-section">
                <div class="section-title">Configuration</div>
                <div class="config-controls">
                    <label for="configFile" class="file-label">
                        Load Config File
                    </label>
                    <input type="file" id="configFile" class="file-input" accept=".json,.csv" />
                    
                    <button class="btn btn-secondary" onclick="loadSampleConfig()">
                        Load Sample Config
                    </button>
                    
                    <button class="btn" onclick="exportConfig()" id="exportBtn" disabled>
                        Export Config
                    </button>
                    
                    <button class="btn btn-secondary" onclick="debugSystemState()">
                        Debug System
                    </button>
                </div>
                
                <div id="configStatus" class="config-status" style="display: none;">
                    Ready to load configuration
                </div>
            </div>

            <!-- System Metrics -->
            <div class="sidebar-section">
                <div class="section-title">System Metrics</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="binCount">0</div>
                        <div class="metric-label">Active Bins</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="truckCount">0</div>
                        <div class="metric-label">Trucks</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="urgentBins">0</div>
                        <div class="metric-label">Urgent Bins</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="agentCount">0/0</div>
                        <div class="metric-label">Agents</div>
                    </div>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="sidebar-section">
                <div class="section-title">Simulation</div>
                <div class="simulation-controls">
                    <button class="btn" onclick="startSimulation()" id="startBtn" disabled>
                        ‚ñ∂Ô∏è Start
                    </button>
                    <button class="btn btn-danger" onclick="pauseSimulation()" id="pauseBtn" disabled>
                        ‚è∏Ô∏è Pause
                    </button>
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="font-size: 0.85rem; opacity: 0.8;">Simulation Speed</label>
                    <input type="range" id="speedSlider" min="0.5" max="25" step="0.5" value="1" 
                           style="width: 100%; margin-top: 5px;" disabled>
                    <div style="text-align: center; font-size: 0.8rem; margin-top: 5px;">
                        <span id="speedValue">1.0x</span>
                    </div>
                </div>
                
                <div class="simulation-info" id="simulationInfo">
                    <div><strong>Status:</strong> <span id="simStatus">Stopped</span></div>
                    <div><strong>Time:</strong> <span id="simTime">--:--</span></div>
                    <div><strong>Speed:</strong> <span id="simSpeed">1.0x</span></div>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="connection-status">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div id="connectionIndicator" class="loading-spinner"></div>
                    <span id="connectionStatus">Connecting to backend...</span>
                </div>
                <div>
                    <span id="lastUpdate">Last update: Never</span>
                </div>
            </div>
            
            <!-- Debug Section -->
            <div class="debug-section" id="debugSection" style="display: none;">
                <h4>Debug Information</h4>
                <div class="debug-info" id="debugInfo">
                    No debug data available
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let markers = {
            bins: new Map(),
            trucks: new Map(),
            depot: null
        };
        let systemState = null;
        let currentConfig = null;
        let updateInterval = null;
        let isUpdating = false;
        let simulationState = {
            running: false,
            currentTime: null,
            speed: 1.0
        };

        // API Configuration
        const API_BASE = 'http://localhost:8000/api';

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            startUpdateLoop();
            showConfigStatus('Ready to load configuration', 'loading');
        });

        function initializeMap() {
            map = L.map('map').setView([33.6844, 73.0479], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        function setupEventListeners() {
            document.getElementById('configFile').addEventListener('change', handleFileUpload);
            
            document.getElementById('speedSlider').addEventListener('input', function(e) {
                const speed = parseFloat(e.target.value);
                document.getElementById('speedValue').textContent = speed + 'x';
                document.getElementById('simSpeed').textContent = speed + 'x';
                setSimulationSpeed(speed);
            });
        }

        // API Communication
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                console.log(`üåê API Call: ${method} ${API_BASE}${endpoint}`);
                if (data) console.log('üì§ Request data:', data);

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('üì• Response:', result);
                return result;

            } catch (error) {
                console.error(`‚ùå API Error (${endpoint}):`, error);
                throw error;
            }
        }

        // Configuration Management
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                showConfigStatus('Reading file...', 'loading');
                const text = await file.text();
                
                let config;
                if (file.name.endsWith('.json')) {
                    config = JSON.parse(text);
                } else if (file.name.endsWith('.csv')) {
                    config = await parseCSVConfig(text);
                } else {
                    throw new Error('Unsupported file format. Use JSON or CSV.');
                }

                await processAndUploadConfig(config);

            } catch (error) {
                console.error('‚ùå File processing error:', error);
                showConfigError('File processing error: ' + error.message);
            }
        }

        async function loadSampleConfig() {
            try {
                showConfigStatus('Loading sample configuration...', 'loading');
                
                const sampleConfig = {
                    depot: {
                        name: "Central Depot",
                        latitude: 33.6844,
                        longitude: 73.0479
                    },
                    trucks: [
                        {
                            id: "TRUCK_001",
                            name: "Alpha Truck",
                            capacity: 5000
                        },
                        {
                            id: "TRUCK_002", 
                            name: "Beta Truck",
                            capacity: 7000
                        }
                    ],
                    bins: [
                        {
                            id: "BIN_001",
                            latitude: 33.6854,
                            longitude: 73.0489,
                            capacity_l: 120,
                            fill_level: 75.5,
                            fill_rate_lph: 4.2
                        },
                        {
                            id: "BIN_002",
                            latitude: 33.6834,
                            longitude: 73.0469,
                            capacity_l: 100,
                            fill_level: 45.2,
                            fill_rate_lph: 2.8
                        },
                        {
                            id: "BIN_003",
                            latitude: 33.6874,
                            longitude: 73.0499,
                            capacity_l: 150,
                            fill_level: 88.7,
                            fill_rate_lph: 6.1
                        },
                        {
                            id: "BIN_004",
                            latitude: 33.6824,
                            longitude: 73.0449,
                            capacity_l: 80,
                            fill_level: 32.1,
                            fill_rate_lph: 1.9
                        },
                        {
                            id: "BIN_005",
                            latitude: 33.6864,
                            longitude: 73.0519,
                            capacity_l: 200,
                            fill_level: 67.8,
                            fill_rate_lph: 8.3
                        }
                    ]
                };

                await processAndUploadConfig(sampleConfig);

            } catch (error) {
                console.error('‚ùå Sample config error:', error);
                showConfigError('Failed to load sample configuration: ' + error.message);
            }
        }

        async function processAndUploadConfig(config) {
            try {
                showConfigStatus('Validating configuration...', 'loading');
                
                const validatedConfig = validateConfig(config);
                console.log('‚úÖ Config validation passed:', validatedConfig);
                
                currentConfig = validatedConfig;
                await uploadConfigToBackend(validatedConfig);

            } catch (error) {
                console.error('‚ùå Config processing error:', error);
                showConfigError('Config processing error: ' + error.message);
            }
        }

        function validateConfig(config) {
            if (!config || typeof config !== 'object') {
                throw new Error('Invalid config: must be an object');
            }

            if (!config.depot || !config.depot.latitude || !config.depot.longitude) {
                throw new Error('Invalid depot: missing coordinates');
            }

            if (!Array.isArray(config.trucks) || config.trucks.length === 0) {
                throw new Error('Invalid trucks: must be non-empty array');
            }

            if (!Array.isArray(config.bins) || config.bins.length === 0) {
                throw new Error('Invalid bins: must be non-empty array');
            }

            // Validate bins
            config.bins.forEach((bin, i) => {
                if (!bin.id || bin.latitude === undefined || bin.longitude === undefined) {
                    throw new Error(`Invalid bin ${i}: missing required fields`);
                }
                
                if (!bin.capacity_l) {
                    bin.capacity_l = 100;
                }
                if (bin.fill_level === undefined) bin.fill_level = 50.0;
                if (bin.fill_rate_lph === undefined) bin.fill_rate_lph = 3.0;
            });

            return config;
        }

        async function uploadConfigToBackend(config) {
            try {
                showConfigStatus('Uploading configuration...', 'loading');
                
                console.log('üì§ Uploading config to backend:', config);
                
                const result = await apiCall('/load-config', 'POST', config);
                
                if (result && result.status === 'success') {
                    console.log('‚úÖ Config upload successful:', result);
                    showConfigStatus(`‚úÖ Config uploaded: ${result.trucks} trucks, ${result.bins} bins`, 'success');
                    
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('speedSlider').disabled = false;
                    
                    if (config.depot) {
                        map.setView([config.depot.latitude, config.depot.longitude], 14);
                    }
                    
                    setTimeout(async () => {
                        console.log('üîç Checking system state after config upload...');
                        await updateSystemState();
                        await debugSystemState();
                    }, 1000);
                    
                } else {
                    throw new Error('Backend rejected configuration: ' + JSON.stringify(result));
                }
            } catch (error) {
                console.error('‚ùå Config upload error:', error);
                showConfigError('Failed to upload configuration: ' + error.message);
            }
        }

        function exportConfig() {
            if (currentConfig) {
                try {
                    const config = {
                        exported_at: new Date().toISOString(),
                        ...currentConfig
                    };
                    
                    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'cleanify_config.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showConfigStatus('‚úÖ Configuration exported', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    showConfigError('Failed to export configuration');
                }
            }
        }

        // Update Functions
        async function updateSystemState() {
            if (isUpdating) return;
            isUpdating = true;

            try {
                const state = await apiCall('/system-state');
                if (state) {
                    systemState = state;
                    updateMap();
                    updateMetrics();
                    updateSimulationInfo();
                    updateConnectionStatus('System Online');
                    document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleTimeString();
                } else {
                    updateConnectionStatus('API Unavailable', true);
                }
            } catch (error) {
                console.error('Update system state error:', error);
                updateConnectionStatus('Update Error', true);
            } finally {
                isUpdating = false;
            }
        }

        function updateMap() {
            if (!systemState) return;

            console.log('üó∫Ô∏è Updating map with system state:', systemState);

            // Clear existing markers
            clearMarkers();

            // Add depot marker
            if (currentConfig && currentConfig.depot) {
                markers.depot = L.circleMarker([currentConfig.depot.latitude, currentConfig.depot.longitude], {
                    radius: 12,
                    fillColor: '#FF5722',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`<b>Depot:</b> ${currentConfig.depot.name}`);
            }

            // Add bin markers
            if (systemState.bins && Array.isArray(systemState.bins)) {
                console.log(`üìç Adding ${systemState.bins.length} bin markers`);
                
                systemState.bins.forEach((bin, index) => {
                    console.log(`Processing bin ${index + 1}:`, bin);
                    
                    if (bin.lat && bin.lon && !isNaN(bin.lat) && !isNaN(bin.lon)) {
                        const fillLevel = bin.fill_level || 0;
                        const color = getFillLevelColor(fillLevel);
                        
                        const marker = L.circleMarker([bin.lat, bin.lon], {
                            radius: Math.max(6, 6 + (fillLevel / 100) * 4),
                            fillColor: color,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);

                        const popupContent = `
                            <b>Bin:</b> ${bin.id}<br>
                            <b>Fill Level:</b> ${fillLevel.toFixed(1)}%<br>
                            <b>Capacity:</b> ${bin.capacity_l}L<br>
                            <b>Rate:</b> ${bin.fill_rate_lph}L/h<br>
                            <b>Status:</b> ${fillLevel >= 95 ? 'Critical' : fillLevel >= 85 ? 'Urgent' : 'Normal'}
                        `;
                        marker.bindPopup(popupContent);
                        
                        markers.bins.set(bin.id, marker);
                        console.log(`‚úÖ Added bin marker for ${bin.id} at [${bin.lat}, ${bin.lon}] - ${fillLevel.toFixed(1)}%`);
                    } else {
                        console.warn(`‚ùå Bin ${bin.id} has invalid coordinates:`, { lat: bin.lat, lon: bin.lon });
                    }
                });
                
                console.log(`‚úÖ Successfully added ${markers.bins.size} bin markers to map`);
            } else {
                console.log('‚ö†Ô∏è No bins in system state or bins is not an array');
            }

            // Add truck markers
            if (systemState.trucks && Array.isArray(systemState.trucks)) {
                console.log(`üöõ Adding ${systemState.trucks.length} truck markers`);
                
                systemState.trucks.forEach((truck, index) => {
                    if (truck.lat && truck.lon && !isNaN(truck.lat) && !isNaN(truck.lon)) {
                        const marker = L.circleMarker([truck.lat, truck.lon], {
                            radius: 10,
                            fillColor: '#2196F3',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);

                        const popupContent = `
                            <b>Truck:</b> ${truck.name || truck.id}<br>
                            <b>Status:</b> ${truck.status}<br>
                            <b>Load:</b> ${truck.current_load_l}/${truck.capacity_l}L<br>
                            <b>Utilization:</b> ${(((truck.current_load_l || 0) / (truck.capacity_l || 1)) * 100).toFixed(1)}%
                        `;
                        marker.bindPopup(popupContent);
                        
                        markers.trucks.set(truck.id, marker);
                        console.log(`‚úÖ Added truck marker for ${truck.id}`);
                    }
                });
            }
        }

        function updateMetrics() {
            if (!systemState) return;

            const binCount = systemState.bins ? systemState.bins.length : 0;
            const truckCount = systemState.trucks ? systemState.trucks.length : 0;
            const urgentBins = systemState.bins ? systemState.bins.filter(bin => bin.fill_level >= 85).length : 0;

            document.getElementById('binCount').textContent = binCount;
            document.getElementById('truckCount').textContent = truckCount;
            document.getElementById('urgentBins').textContent = urgentBins;
        }

        function updateSimulationInfo() {
            if (!systemState) return;

            const isRunning = systemState.simulation_running || false;
            const currentTime = systemState.current_time;
            const speed = systemState.simulation_speed || 1.0;

            // Sync speed slider with backend
            document.getElementById('speedSlider').value = speed;
            document.getElementById('speedValue').textContent = speed + 'x';
            document.getElementById('simSpeed').textContent = speed + 'x';

            // Fix time display
            let timeDisplay = '--:--';
            if (currentTime && currentTime !== 'undefined') {
                try {
                    const timeObj = new Date(currentTime);
                    timeDisplay = timeObj.toLocaleTimeString('en-US', {
                        hour12: false,
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                } catch (e) {
                    timeDisplay = '--:--';
                }
            }
            
            document.getElementById('simTime').textContent = timeDisplay;
            document.getElementById('simStatus').textContent = isRunning ? 'Running' : 'Stopped';
        }

        function clearMarkers() {
            markers.bins.forEach(marker => map.removeLayer(marker));
            markers.trucks.forEach(marker => map.removeLayer(marker));
            if (markers.depot) map.removeLayer(markers.depot);
            
            markers.bins.clear();
            markers.trucks.clear();
            markers.depot = null;
        }

        function getFillLevelColor(fillLevel) {
            if (fillLevel >= 95) return '#F44336';      // Red - Critical
            if (fillLevel >= 85) return '#FF9800';      // Orange - High  
            if (fillLevel >= 50) return '#FFC107';      // Yellow - Medium
            return '#4CAF50';                           // Green - Low
        }

        // Simulation Controls
        async function startSimulation() {
            try {
                showConfigStatus('Starting simulation...', 'loading');
                const result = await apiCall('/simulation/start', 'POST');
                
                if (result && result.status === 'simulation_started') {
                    showConfigStatus('Simulation started', 'success');
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('pauseBtn').disabled = false;
                    document.getElementById('simStatus').textContent = 'Running';
                } else {
                    throw new Error('Invalid simulation start response');
                }
            } catch (error) {
                console.error('Start simulation error:', error);
                showConfigError('Failed to start simulation: ' + error.message);
            }
        }

        async function pauseSimulation() {
            try {
                showConfigStatus('Pausing simulation...', 'loading');
                const result = await apiCall('/simulation/pause', 'POST');
                
                if (result && result.status === 'simulation_paused') {
                    showConfigStatus('‚è∏Ô∏è Simulation paused', 'loading');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                    document.getElementById('simStatus').textContent = 'Stopped';
                } else {
                    throw new Error('Invalid simulation pause response');
                }
            } catch (error) {
                console.error('Pause simulation error:', error);
                showConfigError('Failed to pause simulation: ' + error.message);
            }
        }

        async function setSimulationSpeed(speed) {
            try {
                await apiCall('/simulation/speed', 'POST', { speed });
            } catch (error) {
                console.error('Set speed error:', error);
            }
        }

        async function triggerRoutes() {
            try {
                showConfigStatus('Triggering route planning...', 'loading');
                const result = await apiCall('/routes/trigger', 'POST');
                
                if (result && result.status === 'success') {
                    showConfigStatus(`‚úÖ Routes created: ${result.routes_created}`, 'success');
                } else {
                    showConfigStatus(`‚ö†Ô∏è ${result.message}`, 'loading');
                }
            } catch (error) {
                console.error('Route trigger error:', error);
                showConfigError('Failed to trigger routes: ' + error.message);
            }
        }

        async function getRouteStatus() {
            try {
                const status = await apiCall('/routes/status');
                console.log('üìä Route Status:', status);
                
                // Update debug section with route info
                const debugSection = document.getElementById('debugSection');
                const debugInfo = document.getElementById('debugInfo');
                
                if (status) {
                    debugSection.style.display = 'block';
                    debugInfo.innerHTML = `
                        <strong>Trucks:</strong> ${status.trucks.active}/${status.trucks.total} active (${status.trucks.utilization.toFixed(1)}%)<br>
                        <strong>Bins:</strong> ${status.bins.critical} critical, ${status.bins.urgent} urgent, ${status.bins.being_collected} collecting<br>
                        <strong>Routes:</strong> ${status.system.routes_planned} planned, ${status.system.emergencies_handled} emergencies
                    `;
                }
                
                return status;
            } catch (error) {
                console.error('Route status error:', error);
                return null;
            }
        }

        async function resetSimulation() {
            try {
                showConfigStatus('Resetting simulation...', 'loading');
                const result = await apiCall('/simulation/reset', 'POST');
                
                if (result && result.status === 'success') {
                    showConfigStatus('‚úÖ Simulation reset', 'success');
                    await updateSystemState();
                }
            } catch (error) {
                console.error('Reset error:', error);
                showConfigError('Failed to reset simulation');
            }
        }


        // Debug Functions
        async function debugSystemState() {
            try {
                const debugInfo = await apiCall('/debug/system-state');
                console.log('üêõ Debug info:', debugInfo);
                
                const debugSection = document.getElementById('debugSection');
                const debugInfoDiv = document.getElementById('debugInfo');
                
                if (debugInfo) {
                    debugSection.style.display = 'block';
                    debugInfoDiv.innerHTML = `
                        System State Exists: ${debugInfo.system_state_exists}<br>
                        Bins Count: ${debugInfo.bins_count}<br>
                        Trucks Count: ${debugInfo.trucks_count}<br>
                        Simulation Running: ${debugInfo.simulation_running}<br>
                        Current Time: ${debugInfo.simulation_current_time || 'N/A'}
                    `;
                } else {
                    debugSection.style.display = 'none';
                }
                
                return debugInfo;
            } catch (error) {
                console.error('Debug error:', error);
                return null;
            }
        }

        // UI Helper Functions
        function showConfigStatus(message, type) {
            const statusDiv = document.getElementById('configStatus');
            statusDiv.textContent = message;
            statusDiv.className = `config-status ${type}`;
            statusDiv.style.display = 'block';
        }

        function showConfigError(message) {
            showConfigStatus('‚ùå ' + message, 'error');
        }

        function updateConnectionStatus(status, isError = false) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('connectionStatus');
            const statusDot = document.getElementById('statusDot');
            
            if (isError) {
                indicator.className = 'status-dot';
                indicator.style.background = '#F44336';
                statusDot.style.background = '#F44336';
                statusText.textContent = status;
            } else {
                indicator.className = 'status-dot';
                indicator.style.background = '#4CAF50';
                statusDot.style.background = '#4CAF50';
                statusText.textContent = status;
            }
        }

        // CSV Parsing Helper
        async function parseCSVConfig(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const bins = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length >= 4) {
                    const bin = {
                        id: values[0] || `BIN_${i}`,
                        latitude: parseFloat(values[1]),
                        longitude: parseFloat(values[2]),
                        capacity_l: parseInt(values[3]) || 100,
                        fill_level: parseFloat(values[4]) || 50,
                        fill_rate_lph: parseFloat(values[5]) || 3.0
                    };
                    bins.push(bin);
                }
            }

            return {
                depot: {
                    name: "CSV Depot",
                    latitude: 33.6844,
                    longitude: 73.0479
                },
                trucks: [
                    { id: "TRUCK_001", name: "Default Truck", capacity: 5000 }
                ],
                bins: bins
            };
        }

        // Main Update Loop
        function startUpdateLoop() {
            updateInterval = setInterval(async () => {
                await updateSystemState();
            }, 3000);

            setTimeout(async () => {
                await updateSystemState();
            }, 1000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>